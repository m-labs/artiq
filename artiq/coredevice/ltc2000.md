# LTC2000 DDS `set_waveform` Function Documentation

## Overview

The `set_waveform` method is a kernel function that configures the DDS (Direct Digital Synthesis) spline waveform generator in the LTC2000 system. This function allows precise control over amplitude modulation and phase/frequency modulation of sinusoidal waveforms using polynomial splines.

## Mathematical Foundation

### Waveform Composition

A LTC2000 channel generates a composite waveform `w(t)` according to:

```
w(t) = b(t) × cos(c(t))
```

Where:
- `b(t)` is a cubic spline controlling amplitude modulation
- `c(t)` is a quadratic spline controlling phase/frequency modulation
- `t` represents time in seconds

### Spline Definitions

The class specifically controls the `b(t)` and `c(t)` components:

**Amplitude Modulation Spline b(t):**
```
b(t) = g × (q₀ + q₁t + (q₂t²)/2 + (q₃t³)/6)
```

**Phase/Frequency Modulation Spline c(t):**
```
c(t) = r₀ + r₁t + (r₂t²)/2
```

Where:
- `b(t)` amplitude is in volts
- `c(t)` phase is in number of turns (1 turn = 2π radians)

## Function Signature

```python
@kernel
def set_waveform(self, b0: TInt32, b1: TInt32, b2: TInt64, b3: TInt64,
                 c0: TInt32, c1: TInt32, c2: TInt32, shift: TInt32 = 0):
```

## Parameters

### Amplitude Coefficients (b-series)

| Parameter | Type | Width | Description |
|-----------|------|-------|-------------|
| **b0** | TInt32 | 16 bits | Amplitude offset coefficient (q₀) |
| **b1** | TInt32 | 32 bits | First derivative coefficient |
| **b2** | TInt64 | 48 bits | Second derivative coefficient |
| **b3** | TInt64 | 48 bits | Third derivative coefficient |

### Phase/Frequency Coefficients (c-series)

| Parameter | Type | Width | Description |
|-----------|------|-------|-------------|
| **c0** | TInt32 | 16 bits | Phase offset coefficient (r₀) |
| **c1** | TInt32 | 32 bits | Frequency coefficient |
| **c2** | TInt32 | 32 bits | Chirp rate coefficient |

### Timing Control

| Parameter | Type | Range | Description |
|-----------|------|-------|-------------|
| **shift** | TInt32 | 0-15 | Clock division factor for spline update rate |

## Coefficient Transformation

The relationship between mathematical coefficients (q, r) and hardware coefficients (b, c) uses the time constant `T = 8 × 10⁻⁹` seconds:

### Amplitude Coefficients
```
b₀ = q₀
b₁ = q₁T + (q₂T²)/2 + (q₃T³)/6
b₂ = q₂T² + q₃T³
b₃ = q₃T³
```

### Phase/Frequency Coefficients
```
c₀ = r₀
c₁ = r₁T + (r₂T²)/2
c₂ = r₂T²
```

## Timing Control with Shift Parameter

The `shift` parameter provides precise control over spline evolution rate by dividing the update clock for splines while the DDS core always remains running at full clock speed:

| Shift Value | Division Factor | Update Rate | Duration Multiplier |
|-------------|----------------|-------------|-------------------|
| 0 | 1 | Normal | 1× |
| 1 | 2 | Half rate | 2× |
| 2 | 4 | Quarter rate | 4× |
| 3 | 8 | 1/8 rate | 8× |
| ... | ... | ... | ... |
| 15 | 32,768 | 1/32768 rate | 32,768× |

This allows the same coefficient set to generate waveforms with vastly different time scales, from microseconds to seconds while maintaining the RF performance of the DDS core at max frequency.

## Implementation Details

### Data Packing

The function packs coefficients into a 240-bit data structure sent to the hardware:

```
Bit Range    | Content              | Source
[15:0]       | Amplitude offset     | b0 & 0xFFFF
[31:16]      | First deriv (low)    | b1 & 0xFFFF
[47:32]      | First deriv (high)   | (b1 >> 16) & 0xFFFF
[63:48]      | Second deriv (low)   | b2 & 0xFFFF
[79:64]      | Second deriv (mid)   | (b2 >> 16) & 0xFFFF
[95:80]      | Second deriv (high)  | (b2 >> 32) & 0xFFFF
[111:96]     | Third deriv (low)    | b3 & 0xFFFF
[127:112]    | Third deriv (mid)    | (b3 >> 16) & 0xFFFF
[143:128]    | Third deriv (high)   | (b3 >> 32) & 0xFFFF
[159:144]    | Phase offset         | c0 & 0xFFFF
[175:160]    | Frequency (low)      | c1 & 0xFFFF
[191:176]    | Frequency (high)     | (c1 >> 16) & 0xFFFF
[207:192]    | Chirp (low)          | c2 & 0xFFFF
[223:208]    | Chirp (high)         | (c2 >> 16) & 0xFFFF
[227:224]    | Shift factor         | shift & 0xF
[239:228]    | Reserved             | 0 (12 bits)
```

### Parameter Validation

The function includes input validation:
- `shift` must be in range [0, 15]

## Usage Notes

### Triggering Requirement

**Critical:** The waveform configuration is not applied to the LTC2000 Core until explicitly triggered using the `Trigger` class. This allows atomic updates across multiple channels.

```python
# Configure waveform
dds.set_waveform(b0=1000, b1=500, b2=100, b3=0,
                 c0=0, c1=1000000, c2=0, shift=2)

# Apply the configuration
trigger.trigger(0x0001)  # Trigger channel 0
```

## Example Applications

### Constant Amplitude Sine Wave
```python
# Simple sine wave: b(t) = 1.0V, c(t) = f₀t
dds.set_waveform(b0=shuttler_volt_to_mu(1.0), b1=0, b2=0, b3=0,
                 c0=0, c1=frequency_to_mu(1e6), c2=0, shift=0)
```

### Linear Frequency Sweep
```python
# Chirped sine: constant amplitude, linear frequency sweep
dds.set_waveform(b0=shuttler_volt_to_mu(0.5), b1=0, b2=0, b3=0,
                 c0=0, c1=start_freq_mu, c2=chirp_rate_mu, shift=3)
```

### Amplitude Modulated Signal
```python
# AM signal: b(t) = A₀ + A₁t (linear amplitude ramp)
dds.set_waveform(b0=base_amplitude_mu, b1=ramp_rate_mu, b2=0, b3=0,
                 c0=0, c1=carrier_freq_mu, c2=0, shift=1)
```
